<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>QuickBASIC 64</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: monospace; background: #0000AA; color: white; height: 100vh; display: flex; flex-direction: column; }
.menu { background: #C0C0C0; color: black; padding: 5px 10px; border-bottom: 2px solid #808080; }
.toolbar { background: #D4D0C8; padding: 5px 10px; border-bottom: 2px solid #808080; }
.toolbar button { padding: 5px 15px; margin-right: 5px; cursor: pointer; }
.main { display: flex; flex: 1; overflow: hidden; }
.left { flex: 1; display: flex; flex-direction: column; border-right: 2px solid #404040; }
.right { flex: 1; display: flex; flex-direction: column; background: black; }
.title { background: #0000AA; padding: 5px 10px; font-size: 11px; border-bottom: 1px solid #404040; }
#editor { flex: 1; background: #0000AA; color: yellow; padding: 15px; font-size: 14px; border: none; resize: none; outline: none; }
.canvas-box { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
#canvas { border: 2px solid #404040; image-rendering: pixelated; }
.status { background: #D4D0C8; color: black; padding: 5px 10px; font-size: 11px; display: flex; justify-content: space-between; }
</style>
</head>
<body>
<div class="menu"><b>QuickBASIC 64</b> File Edit View Run Help</div>
<div class="toolbar">
<button id="run" style="background: green; color: white;">Run F5</button>
<button id="stop" style="background: red; color: white;">Stop</button>
<button id="clear" style="background: blue; color: white;">Clear</button>
</div>
<div class="main">
<div class="left">
<div class="title">UNTITLED.BAS</div>
<textarea id="editor" spellcheck="false">REM Starfield & Plasma Demo
SCREEN 2
CLS

REM Draw a colorful border
FOR i = 0 TO 319
  PSET (i, 0), i MOD 16
  PSET (i, 199), i MOD 16
NEXT i
FOR i = 0 TO 199
  PSET (0, i), i MOD 16
  PSET (319, i), i MOD 16
NEXT i

REM Draw plasma-like pattern
FOR y = 20 TO 90
  FOR x = 20 TO 150
    c = SIN(x / 8) * 4 + COS(y / 6) * 4 + 8
    PSET (x, y), c
  NEXT x
NEXT y

REM Draw starfield
FOR i = 0 TO 80
  sx = 170 + INT(RND * 140)
  sy = 10 + INT(RND * 100)
  PSET (sx, sy), 15
NEXT i

REM Draw mountain range
FOR x = 10 TO 309
  h = 140 + SIN(x / 20) * 15 + SIN(x / 7) * 8
  LINE (x, 190)-(x, h), 2
NEXT x

REM Draw sun with rays
CIRCLE (270, 50), 20, 14
FOR a = 0 TO 12
  rx = 270 + 30 * COS(a * 0.5)
  ry = 50 + 30 * SIN(a * 0.5)
  LINE (270, 50)-(rx, ry), 14
NEXT a

REM Title
LOCATE 24, 12
PRINT "QUICKBASIC 64 DEMO"</textarea>
</div>
<div class="right">
<div class="title">OUTPUT</div>
<div class="canvas-box"><canvas id="canvas" width="640" height="400"></canvas></div>
</div>
</div>
<div class="status"><span id="msg">Ready</span><span id="pos">Ln 1 Col 1</span></div>
<script>
var c = document.getElementById('canvas');
var ctx = c.getContext('2d');
var ed = document.getElementById('editor');
var msg = document.getElementById('msg');
var running = false;
var stop = false;
var mode = 0;
var tx = 0, ty = 0;
var cols = ['#000','#00A','#0A0','#0AA','#A00','#A0A','#A50','#AAA','#555','#55F','#5F5','#5FF','#F55','#F5F','#FF5','#FFF'];

function clr() {
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, c.width, c.height);
}

function run() {
  if (running) return;
  running = true;
  stop = false;
  document.getElementById('run').disabled = true;
  msg.textContent = 'Running...';
  clr();
  
  var code = ed.value;
  var lines = code.split('\n');
  var vars = {};
  var pc = 0; // program counter
  var forStack = []; // stack for nested FOR loops
  var batchCount = 0;
  var batchLimit = 50; // execute this many lines before yielding
  
  function findMatchingNext(startLine) {
    var depth = 1;
    for (var j = startLine + 1; j < lines.length; j++) {
      var t = lines[j].trim().toUpperCase();
      if (t.indexOf('FOR') === 0 && t.indexOf('FORMAT') !== 0) depth++;
      if (t.indexOf('NEXT') === 0) {
        depth--;
        if (depth === 0) return j;
      }
    }
    return lines.length; // not found, go to end
  }
  
  function step() {
    if (pc >= lines.length || stop) {
      msg.textContent = stop ? 'Stopped' : 'Done';
      running = false;
      document.getElementById('run').disabled = false;
      return;
    }
    
    var line = lines[pc].trim();
    var u = line.toUpperCase();
    
    // Skip empty lines and comments
    if (!line || u.indexOf('REM') === 0 || line.indexOf("'") === 0) {
      pc++;
      batchCount++;
      if (batchCount >= batchLimit) {
        batchCount = 0;
        setTimeout(step, 1);
      } else {
        step();
      }
      return;
    }
    
    // FOR loop
    if (u.indexOf('FOR') === 0 && u.indexOf('FORMAT') !== 0) {
      var m = line.match(/FOR\s+(\w+)\s*=\s*(.+?)\s+TO\s+(.+?)(?:\s+STEP\s+(.+))?$/i);
      if (m) {
        var varName = m[1];
        var startVal = calc(m[2], vars);
        var endVal = calc(m[3], vars);
        var stepVal = m[4] ? calc(m[4], vars) : 1;
        var nextLine = findMatchingNext(pc);
        
        vars[varName] = startVal;
        
        // Check if loop should execute at all
        if ((stepVal > 0 && startVal > endVal) || (stepVal < 0 && startVal < endVal)) {
          pc = nextLine + 1; // skip past NEXT
        } else {
          forStack.push({
            varName: varName,
            endVal: endVal,
            stepVal: stepVal,
            loopStart: pc + 1,
            nextLine: nextLine
          });
          pc++;
        }
        batchCount++;
        if (batchCount >= batchLimit) {
          batchCount = 0;
          setTimeout(step, 1);
        } else {
          step();
        }
        return;
      }
    }
    
    // NEXT statement
    if (u.indexOf('NEXT') === 0) {
      if (forStack.length > 0) {
        var loop = forStack[forStack.length - 1];
        vars[loop.varName] += loop.stepVal;
        
        var done = (loop.stepVal > 0) 
          ? vars[loop.varName] > loop.endVal 
          : vars[loop.varName] < loop.endVal;
        
        if (done) {
          forStack.pop();
          pc++;
        } else {
          pc = loop.loopStart;
        }
      } else {
        pc++; // NEXT without FOR, just skip
      }
      batchCount++;
      if (batchCount >= batchLimit) {
        batchCount = 0;
        setTimeout(step, 1);
      } else {
        step();
      }
      return;
    }
    
    // Regular statement
    exec(line, vars);
    pc++;
    batchCount++;
    if (batchCount >= batchLimit) {
      batchCount = 0;
      setTimeout(step, 1);
    } else {
      step();
    }
  }
  
  step();
}

function parseArgs(str) {
  // Remove outer parentheses and split by comma, respecting nested parens
  str = str.trim();
  var args = [];
  var depth = 0;
  var current = '';
  for (var i = 0; i < str.length; i++) {
    var ch = str[i];
    if (ch === '(' || ch === ')') {
      depth += (ch === '(' ? 1 : -1);
      current += ch;
    } else if (ch === ',' && depth === 0) {
      args.push(current.trim());
      current = '';
    } else {
      current += ch;
    }
  }
  if (current.trim()) args.push(current.trim());
  return args;
}

function exec(line, vars) {
  // Skip NEXT statements (handled by FOR)
  if (line.toUpperCase().indexOf('NEXT') === 0) return;
  
  // Variable assignment: x = expr
  if (line.match(/^[a-zA-Z_]\w*\s*=/) && !line.toUpperCase().match(/^(SCREEN|CLS|PSET|LINE|CIRCLE|PRINT|LOCATE)/)) {
    var p = line.indexOf('=');
    var n = line.substring(0, p).trim();
    var x = line.substring(p + 1).trim();
    vars[n] = calc(x, vars);
    return;
  }
  
  var u = line.toUpperCase();
  
  if (u.indexOf('SCREEN') === 0) {
    var m = parseInt(line.substring(6).trim());
    mode = m;
    c.width = m === 13 ? 320 : 640;
    c.height = m === 13 ? 200 : 400;
    clr();
  } else if (u.indexOf('CLS') === 0) {
    clr();
    tx = 0; ty = 0;
  } else if (u.indexOf('PSET') === 0) {
    // PSET (x, y), color  OR  PSET x, y, color
    var rest = line.substring(4).trim();
    var x, y, col;
    
    if (rest[0] === '(') {
      // Format: PSET (x, y), color
      var closeParen = rest.indexOf(')');
      var coords = rest.substring(1, closeParen);
      var coordParts = coords.split(',');
      x = calc(coordParts[0], vars);
      y = calc(coordParts[1], vars);
      var afterParen = rest.substring(closeParen + 1).trim();
      if (afterParen[0] === ',') {
        col = calc(afterParen.substring(1), vars);
      } else {
        col = 15;
      }
    } else {
      // Format: PSET x, y, color
      var args = parseArgs(rest);
      x = calc(args[0], vars);
      y = calc(args[1], vars);
      col = args[2] ? calc(args[2], vars) : 15;
    }
    
    var sc = mode === 13 ? 2 : 1;
    ctx.fillStyle = cols[Math.floor(col) % 16];
    ctx.fillRect(Math.floor(x) * sc, Math.floor(y) * sc, sc, sc);
  } else if (u.indexOf('LINE') === 0) {
    // LINE (x1, y1)-(x2, y2), color  OR  LINE x1, y1, x2, y2, color
    var rest = line.substring(4).trim();
    var x1, y1, x2, y2, col;
    
    if (rest[0] === '(') {
      // Format: LINE (x1, y1)-(x2, y2), color
      var dashPos = rest.indexOf('-');
      var firstCoords = rest.substring(1, rest.indexOf(')'));
      var firstParts = firstCoords.split(',');
      x1 = calc(firstParts[0], vars);
      y1 = calc(firstParts[1], vars);
      
      var afterDash = rest.substring(dashPos + 1).trim();
      var secondStart = afterDash.indexOf('(') + 1;
      var secondEnd = afterDash.indexOf(')');
      var secondCoords = afterDash.substring(secondStart, secondEnd);
      var secondParts = secondCoords.split(',');
      x2 = calc(secondParts[0], vars);
      y2 = calc(secondParts[1], vars);
      
      var afterSecond = afterDash.substring(secondEnd + 1).trim();
      if (afterSecond[0] === ',') {
        col = calc(afterSecond.substring(1).split(',')[0], vars);
      } else {
        col = 15;
      }
    } else {
      // Format: LINE x1, y1, x2, y2, color
      var args = parseArgs(rest);
      x1 = calc(args[0], vars);
      y1 = calc(args[1], vars);
      x2 = calc(args[2], vars);
      y2 = calc(args[3], vars);
      col = args[4] ? calc(args[4], vars) : 15;
    }
    
    var sc = mode === 13 ? 2 : 1;
    ctx.strokeStyle = cols[Math.floor(col) % 16];
    ctx.lineWidth = sc;
    ctx.beginPath();
    ctx.moveTo(Math.floor(x1) * sc + 0.5, Math.floor(y1) * sc + 0.5);
    ctx.lineTo(Math.floor(x2) * sc + 0.5, Math.floor(y2) * sc + 0.5);
    ctx.stroke();
  } else if (u.indexOf('CIRCLE') === 0) {
    // CIRCLE (x, y), radius, color  OR  CIRCLE x, y, radius, color
    var rest = line.substring(6).trim();
    var x, y, r, col;
    
    if (rest[0] === '(') {
      // Format: CIRCLE (x, y), radius, color
      var closeParen = rest.indexOf(')');
      var coords = rest.substring(1, closeParen);
      var coordParts = coords.split(',');
      x = calc(coordParts[0], vars);
      y = calc(coordParts[1], vars);
      
      var afterParen = rest.substring(closeParen + 1).trim();
      if (afterParen[0] === ',') {
        var remaining = parseArgs(afterParen.substring(1));
        r = calc(remaining[0], vars);
        col = remaining[1] ? calc(remaining[1], vars) : 15;
      }
    } else {
      // Format: CIRCLE x, y, radius, color
      var args = parseArgs(rest);
      x = calc(args[0], vars);
      y = calc(args[1], vars);
      r = calc(args[2], vars);
      col = args[3] ? calc(args[3], vars) : 15;
    }
    
    var sc = mode === 13 ? 2 : 1;
    ctx.strokeStyle = cols[Math.floor(col) % 16];
    ctx.lineWidth = sc;
    ctx.beginPath();
    ctx.arc(Math.floor(x) * sc, Math.floor(y) * sc, Math.floor(r) * sc, 0, Math.PI * 2);
    ctx.stroke();
  } else if (u.indexOf('PRINT') === 0) {
    var txt = line.substring(5).trim();
    // Remove quotes
    txt = txt.replace(/^["']|["']$/g, '');
    ctx.fillStyle = '#FFF';
    ctx.font = (mode === 13 ? '16' : '16') + 'px monospace';
    ctx.fillText(txt, tx, ty + 16);
    ty += 16;
  } else if (u.indexOf('LOCATE') === 0) {
    var args = parseArgs(line.substring(6));
    ty = (parseInt(args[0]) - 1) * 16;
    tx = (parseInt(args[1]) - 1) * 8;
  }
}

function calc(expr, vars) {
  if (expr === undefined || expr === null) return 0;
  expr = String(expr).trim();
  
  // Replace variable names with their values
  expr = expr.replace(/\b([a-zA-Z_]\w*)\b/g, function(m) {
    var upper = m.toUpperCase();
    if (['COS','SIN','TAN','ATN','SQR','ABS','INT','RND','MOD','TO','STEP','AND','OR','NOT'].indexOf(upper) !== -1) {
      return m;
    }
    return vars[m] !== undefined ? vars[m] : m;
  });
  
  // Replace BASIC functions with JS equivalents
  expr = expr.replace(/COS\s*\(/gi, 'Math.cos(');
  expr = expr.replace(/SIN\s*\(/gi, 'Math.sin(');
  expr = expr.replace(/TAN\s*\(/gi, 'Math.tan(');
  expr = expr.replace(/ATN\s*\(/gi, 'Math.atan(');
  expr = expr.replace(/SQR\s*\(/gi, 'Math.sqrt(');
  expr = expr.replace(/ABS\s*\(/gi, 'Math.abs(');
  expr = expr.replace(/INT\s*\(/gi, 'Math.floor(');
  expr = expr.replace(/\bRND\b/gi, 'Math.random()');
  expr = expr.replace(/\bMOD\b/gi, '%');
  
  try {
    return eval(expr);
  } catch (e) {
    console.error('Calc error:', expr, e);
    return 0;
  }
}

document.getElementById('run').onclick = run;
document.getElementById('stop').onclick = function() { stop = true; };
document.getElementById('clear').onclick = function() { clr(); msg.textContent = 'Cleared'; };
document.onkeydown = function(e) { if (e.key === 'F5') { e.preventDefault(); run(); } };
ed.onclick = ed.onkeyup = function() {
  var l = ed.value.substring(0, ed.selectionStart).split('\n');
  document.getElementById('pos').textContent = 'Ln ' + l.length + ' Col ' + (l[l.length-1].length + 1);
};
clr();
</script>
</body>
</html>
